<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA Medical Pay Calculator</title>
    <style>
        :root { --primary: #00566b; --bg: #f0f4f7; --card: #ffffff; --text: #1a1a1a; --border: #dde1e6; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); padding: 20px; max-width: 1200px; margin: 0 auto; 
        }
        h2 { border-bottom: 4px solid var(--primary); padding-bottom: 12px; color: var(--primary); margin-top: 0; }
        
        .panel { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid var(--border); }
        .controls-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: end; }
        .control-group { flex: 1; min-width: 250px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
        select, input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        @media (max-width: 1000px) { .grid-container { grid-template-columns: 1fr; } }
        
        .week-card { background: var(--card); border-radius: 10px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--border); }
        .week-header { font-weight: 800; color: var(--primary); margin-bottom: 12px; text-transform: uppercase; font-size: 13px; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; display: flex; justify-content: space-between; }

        .day-row { display: grid; grid-template-columns: 40px 75px 75px 60px 60px 30px 1fr; gap: 8px; align-items: center; margin-bottom: 10px; }
        .day-label { font-weight: 600; font-size: 13px; color: #444; }
        
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center; width: 100%; font-family: monospace; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--primary); background: #f0fbff; outline: none; }
        
        .unrost-in { background: #fff5f5; border-color: #ffcccc !important; color: #c0392b; font-weight: 600; }
        .oncall-in { background: #f3f6f8; border-color: #dbe4e8 !important; color: #2c3e50; font-size: 12px; }

        /* Status Badges */
        .status-cell { display: flex; flex-wrap: wrap; gap: 4px; min-height: 22px; align-items: center; }
        .badge { font-size: 10px; font-weight: 700; padding: 3px 6px; border-radius: 4px; color: white; white-space: nowrap; letter-spacing: 0.5px; }
        
        /* Badge Colors */
        .bg-ord { background-color: #95a5a6; } 
        .bg-eve { background-color: #16a085; }   /* Teal */
        .bg-night { background-color: #2c3e50; } /* Navy */
        .bg-sat { background-color: #e67e22; }   /* Orange */
        .bg-sun { background-color: #c0392b; }   /* Red */
        .bg-ph { background-color: #8e44ad; }    /* Purple */
        .bg-ot { background-color: #c0392b; border: 1px solid #a93226; } /* Red OT */
        .bg-pda { background-color: #2980b9; }

        .payslip-box { background: white; border-radius: 10px; border: 1px solid #e0e0e0; margin-top: 30px; padding: 0; overflow: hidden; }
        .payslip-head { background: #34495e; color: white; padding: 16px 24px; font-weight: 700; display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; background: #f8f9fa; padding: 12px 24px; border-bottom: 2px solid #e9ecef; color: #6c757d; font-size: 12px; text-transform: uppercase; }
        td { padding: 12px 24px; border-bottom: 1px solid #f1f1f1; }
        td.amount { text-align: right; font-family: monospace; font-size: 15px; font-weight: 600; }
        .total-row td { background: #f8f9fa; font-weight: 800; font-size: 16px; border-top: 2px solid #34495e; color: #2c3e50; }
        
        .copy-btn { font-size: 11px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; border: 1px solid rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s; }
        .copy-btn:hover { background: rgba(255,255,255,0.3); }

        .disclaimer { text-align:center; padding: 24px; font-size: 12px; color: #7f8c8d; margin-top: 20px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <div>
            <h2>WA Medical Pay Calculator</h2>
            <div style="font-size: 13px; color: #666;">2025/26 Rates (Eff. 3 Sep 2025)</div>
        </div>
    </div>

    <div class="panel">
        <div class="controls-row">
            <div class="control-group">
                <label>Classification (Sep 2025 Rates)</label>
                <select id="roleSelector" onchange="updateUI()">
                    <option value="Intern">Intern ($90,864)</option>
                    <option value="RMO1">RMO Year 1 ($99,395)</option>
                    <option value="RMO2">RMO Year 2 ($108,776)</option>
                    <option value="RMO3">RMO Year 3 ($119,165)</option>
                    <option value="Reg1">Registrar Yr 1 ($125,010)</option>
                    <option value="Reg2">Registrar Yr 2 ($131,150)</option>
                    <option value="Reg3">Registrar Yr 3 ($140,819)</option>
                    <option value="Reg4" selected>Registrar Yr 4 ($147,748)</option>
                    <option value="Reg5">Registrar Yr 5 ($155,023)</option>
                    <option value="Reg6">Registrar Yr 6 ($162,661)</option>
                    <option value="SnrReg1">Snr Reg Yr 1 ($183,317)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Professional Development Allowance</label>
                <select id="pdaSelector" onchange="updateUI()">
                    <option value="0">None</option>
                    <option value="6503">Intern/RMO ($6,503)</option>
                    <option value="11380" selected>Registrar/SMO ($11,380)</option>
                    <option value="16259">Snr Registrar ($16,259)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="grid-container">
        <div class="week-card" id="week1"></div>
        <div class="week-card" id="week2"></div>
    </div>

    <div class="payslip-box">
        <div class="payslip-head">
            <span>ESTIMATED PAYSLIP</span>
            <button class="copy-btn" onclick="copyToClipboard()">Copy Summary</button>
        </div>
        <table id="payslipTable">
            <thead>
                <tr>
                    <th width="45%">Pay Component</th>
                    <th width="15%">Units</th>
                    <th width="15%">Rate</th>
                    <th width="25%" style="text-align:right">Total</th>
                </tr>
            </thead>
            <tbody id="payslipBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3">GROSS TOTAL</td>
                    <td class="amount" id="grossTotal">$0.00</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="disclaimer">
        <strong>Unofficial Estimator | WA Health System â€“ AMA Industrial Agreement 2024</strong><br>
        Using <strong>2025 Rates</strong> (Effective 3 Sep 2025).<br><br>
        <strong>Penalties:</strong> Shift loadings (Eve 1.2x / Night 1.25x) and Overtime (Ext 1.5x/2.0x) are displayed in the status column.
    </div>

<script>
    // === 1. DATA: 2025 RATES (Effective 3 Sep 2025) ===
    const RATES = {
        "Intern": { annual: 90864 },
        "RMO1":   { annual: 99395 },
        "RMO2":   { annual: 108776 },
        "RMO3":   { annual: 119165 },
        "Reg1":   { annual: 125010 },
        "Reg2":   { annual: 131150 },
        "Reg3":   { annual: 140819 },
        "Reg4":   { annual: 147748 },
        "Reg5":   { annual: 155023 },
        "Reg6":   { annual: 162661 },
        "SnrReg1":{ annual: 183317 }
    };

    const ON_CALL_RATE = 13.28; 
    const MEAL_ALLOWANCE = 17.80; 
    const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    // === 2. INIT & STORAGE ===
    function init() {
        renderWeek('week1', 0);
        renderWeek('week2', 7);
        loadData();
    }

    function saveData() {
        const data = {
            role: document.getElementById('roleSelector').value,
            pda: document.getElementById('pdaSelector').value,
            days: []
        };
        for (let i = 0; i < 14; i++) {
            data.days.push({
                start: document.getElementById(`start_${i}`).value,
                end: document.getElementById(`end_${i}`).value,
                unrost: document.getElementById(`unrost_${i}`).value,
                oncall: document.getElementById(`oncall_${i}`).value,
                ph: document.getElementById(`ph_${i}`).checked
            });
        }
        localStorage.setItem('waDocCalcFinalV2', JSON.stringify(data));
    }

    function loadData() {
        const raw = localStorage.getItem('waDocCalcFinalV2');
        if (!raw) { updateUI(); return; }
        try {
            const data = JSON.parse(raw);
            if (data.role) document.getElementById('roleSelector').value = data.role;
            if (data.pda) document.getElementById('pdaSelector').value = data.pda;
            
            if (data.days) {
                data.days.forEach((day, i) => {
                    document.getElementById(`start_${i}`).value = day.start || '';
                    document.getElementById(`end_${i}`).value = day.end || '';
                    document.getElementById(`unrost_${i}`).value = day.unrost || '';
                    document.getElementById(`oncall_${i}`).value = day.oncall || '';
                    document.getElementById(`ph_${i}`).checked = day.ph || false;
                });
            }
            updateUI();
        } catch (e) { console.error(e); }
    }

    function renderWeek(containerId, offset) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="week-header">
                <span>${offset===0 ? "Week 1" : "Week 2"}</span>
                <span>80h Fortnight Cycle</span>
            </div>
            <div class="day-row header-labels">
                <span>Day</span>
                <span>Start</span>
                <span>Finish</span>
                <span title="Unrostered Overtime">U.OT</span>
                <span title="Hours On Call">OC (h)</span>
                <span>PH</span>
                <span>Status</span>
            </div>
        `;

        DAYS.forEach((day, index) => {
            const i = offset + index;
            const div = document.createElement('div');
            div.className = 'day-row';
            div.innerHTML = `
                <span class="day-label">${day}</span>
                <input type="text" id="start_${i}" placeholder="0800" onblur="formatTime(this)" onchange="calculate()">
                <input type="text" id="end_${i}" placeholder="1700" onblur="formatTime(this)" onchange="calculate()">
                <input type="number" id="unrost_${i}" class="unrost-in" placeholder="" tabindex="-1" min="0" max="24" step="0.5" onchange="calculate()">
                <input type="number" id="oncall_${i}" class="oncall-in" placeholder="" tabindex="-1" min="0" max="24" step="0.5" onchange="calculate()">
                <input type="checkbox" id="ph_${i}" tabindex="-1" onchange="calculate()" title="Public Holiday">
                <div id="status_${i}" class="status-cell"></div>
            `;
            container.appendChild(div);
        });
    }

    function formatTime(input) {
        let val = input.value.replace(/[^0-9]/g, '');
        if (!val) return;
        if (val.length <= 2) {
            if (parseInt(val) < 10) val = "0" + parseInt(val);
            input.value = val + ":00";
        } else if (val.length >= 3) {
            if (val.length === 3) val = "0" + val;
            input.value = val.substring(0,2) + ":" + val.substring(2,4);
        }
        calculate();
    }

    function updateUI() { calculate(); }

    // === 3. CALCULATION ENGINE ===
    function calculate() {
        saveData();
        
        const roleKey = document.getElementById('roleSelector').value;
        const pdaAnnual = parseFloat(document.getElementById('pdaSelector').value) || 0;
        
        const annualBase = RATES[roleKey].annual;
        const weeklyBase = annualBase / 52.1666;
        const hourlyRate = weeklyBase / 40; 
        const pdaFortnightly = pdaAnnual / 26.08; 

        let buckets = {
            "Ordinary (Rostered)":  { hrs: 0, rate: hourlyRate, total: 0, css: "bg-ord" },
            "Ordinary (Unrostered)":{ hrs: 0, rate: hourlyRate, total: 0, css: "bg-ot" },
            "Shift (Eve 20%)":      { hrs: 0, rate: hourlyRate * 0.20, total: 0, css: "bg-eve" },
            "Shift (Night 25%)":    { hrs: 0, rate: hourlyRate * 0.25, total: 0, css: "bg-night" },
            "Saturday (50%)":       { hrs: 0, rate: hourlyRate * 1.5, total: 0, css: "bg-sat" },
            "Sunday (75%)":         { hrs: 0, rate: hourlyRate * 1.75, total: 0, css: "bg-sun" },
            "Public Holiday (150%)":{ hrs: 0, rate: hourlyRate * 2.5, total: 0, css: "bg-ph" },
            "Overtime (1.5x)":      { hrs: 0, rate: hourlyRate * 1.5, total: 0, css: "bg-ot" },
            "Overtime (2.0x)":      { hrs: 0, rate: hourlyRate * 2.0, total: 0, css: "bg-ot" },
            "On-Call Allowance":    { hrs: 0, rate: ON_CALL_RATE, total: 0, css: "bg-ord" },
            "Meal Allowance":       { count: 0, rate: MEAL_ALLOWANCE, total: 0, css: "bg-ord" },
            "PDA":                  { count: 1, rate: pdaFortnightly, total: pdaFortnightly, css: "bg-pda" }
        };

        for(let k=0; k<14; k++) document.getElementById(`status_${k}`).innerHTML = '';

        let EligibleSegments = []; 

        for (let i = 0; i < 14; i++) {
            const sVal = document.getElementById(`start_${i}`).value;
            const eVal = document.getElementById(`end_${i}`).value;
            const uOT = parseFloat(document.getElementById(`unrost_${i}`).value) || 0;
            const ocHrs = parseFloat(document.getElementById(`oncall_${i}`).value) || 0;
            const isPH = document.getElementById(`ph_${i}`).checked;
            const dayName = DAYS[i % 7];
            
            let badges = new Set(); 

            // On Call
            if (ocHrs > 0) {
                addToBucket("On-Call Allowance", ocHrs, ON_CALL_RATE);
            }

            // ROSTERED SHIFT
            if (sVal && eVal) {
                let sParts = sVal.split(':');
                let eParts = eVal.split(':');
                let start = new Date(2000, 0, 1, sParts[0], sParts[1]);
                let end = new Date(2000, 0, 1, eParts[0], eParts[1]);
                if (end < start) end.setDate(end.getDate() + 1);
                
                let totalDur = (end - start) / 36e5;
                let sH = start.getHours() + start.getMinutes()/60;
                
                if (totalDur > 10) {
                    buckets["Meal Allowance"].count += 1;
                    buckets["Meal Allowance"].total += MEAL_ALLOWANCE;
                }

                // CLAUSE 17(2): EXTENDED SHIFT (>10h)
                let coreHours = Math.min(totalDur, 10);
                let extHours = Math.max(0, totalDur - 10);

                if (extHours > 0) {
                    if (dayName === 'Sun') {
                        addToBucket("Overtime (2.0x)", extHours, hourlyRate * 2.0);
                        badges.add({txt: `Ext 2.0x (${extHours.toFixed(1)}h)`, css: "bg-ot"});
                    } else {
                        let ot15 = Math.min(extHours, 3);
                        let ot20 = extHours - ot15;
                        addToBucket("Overtime (1.5x)", ot15, hourlyRate * 1.5);
                        badges.add({txt: `Ext 1.5x (${ot15.toFixed(1)}h)`, css: "bg-ot"});
                        if (ot20 > 0) {
                            addToBucket("Overtime (2.0x)", ot20, hourlyRate * 2.0);
                            badges.add({txt: `Ext 2.0x (${ot20.toFixed(1)}h)`, css: "bg-ot"});
                        }
                    }
                }

                // CORE HOURS (0-10h)
                let segments = [];
                let remainingCore = coreHours;
                
                if (end.getDate() > 1) {
                    let durationBeforeMid = 24 - sH;
                    let coreBeforeMid = Math.min(remainingCore, durationBeforeMid);
                    
                    if (coreBeforeMid > 0) {
                        segments.push({ dayIdx: i, s: sH, e: sH + coreBeforeMid, dur: coreBeforeMid, isPH: isPH });
                        remainingCore -= coreBeforeMid;
                    }
                    if (remainingCore > 0) {
                        let nextPH = document.getElementById(`ph_${i+1}`) ? document.getElementById(`ph_${i+1}`).checked : false;
                        segments.push({ dayIdx: i+1, s: 0, e: remainingCore, dur: remainingCore, isPH: nextPH });
                    }
                } else {
                    segments.push({ dayIdx: i, s: sH, e: sH + coreHours, dur: coreHours, isPH: isPH });
                }

                segments.forEach(seg => {
                    let dName = DAYS[seg.dayIdx % 7];
                    let pRate = 1.0; 
                    let bucket = "Ordinary (Rostered)";

                    if (seg.isPH) { 
                        pRate = 2.5; bucket = "Public Holiday (150%)"; 
                        badges.add({txt: "PH 2.5x", css: "bg-ph"});
                    } else if (dName === 'Sun') { 
                        pRate = 1.75; bucket = "Sunday (75%)"; 
                        badges.add({txt: "Sun 1.75x", css: "bg-sun"});
                    } else if (dName === 'Sat') { 
                        pRate = 1.5; bucket = "Saturday (50%)"; 
                        badges.add({txt: "Sat 1.5x", css: "bg-sat"});
                    } else {
                        // Shift Penalties
                        let startT = seg.s;
                        let endT = seg.e;
                        
                        let eveHrs = Math.max(0, Math.min(endT, 24) - Math.max(startT, 18));
                        let nightHrs = Math.max(0, Math.min(endT, 8) - Math.max(startT, 0));
                        
                        if(eveHrs > 0) {
                            addToBucket("Shift (Eve 20%)", eveHrs, hourlyRate * 0.2);
                            badges.add({txt: "Eve 1.2x", css: "bg-eve"});
                        }
                        if(nightHrs > 0) {
                            addToBucket("Shift (Night 25%)", nightHrs, hourlyRate * 0.25);
                            badges.add({txt: "Night 1.25x", css: "bg-night"});
                        }
                    }
                    
                    EligibleSegments.push({ hrs: seg.dur, penaltyRate: pRate, bucket: bucket });
                });
            }

            // UNROSTERED OT
            if (uOT > 0) {
                let pRate = 1.0;
                let bucket = "Ordinary (Unrostered)"; 
                if (isPH) { 
                    pRate = 2.5; bucket = "Public Holiday (150%)"; 
                    badges.add({txt: "PH 2.5x", css: "bg-ph"});
                } else if (dayName === 'Sun') { 
                    pRate = 1.75; bucket = "Sunday (75%)"; 
                    badges.add({txt: "Sun 1.75x", css: "bg-sun"});
                } else if (dayName === 'Sat') { 
                    pRate = 1.5; bucket = "Saturday (50%)"; 
                    badges.add({txt: "Sat 1.5x", css: "bg-sat"});
                }
                
                EligibleSegments.push({ hrs: uOT, penaltyRate: pRate, bucket: bucket });
                badges.add({txt: `U.OT ${uOT}h`, css: "bg-ot"});
            }

            renderBadges(i, badges);
        }

        // AGGREGATE ENGINE
        let cumulative = 0;
        
        EligibleSegments.forEach(seg => {
            let hrs = seg.hrs;
            let currentH = cumulative;
            let rem = hrs;
            
            while(rem > 0) {
                let dur;
                let tier; // 0 (<80), 1 (80-120), 2 (>120)
                
                if (currentH < 80) {
                    dur = Math.min(rem, 80 - currentH);
                    tier = 0;
                } else if (currentH < 120) {
                    dur = Math.min(rem, 120 - currentH);
                    tier = 1;
                } else {
                    dur = rem;
                    tier = 2;
                }
                
                let tierRate = 1.0;
                let otBucket = "";
                
                if (tier === 1) { tierRate = 1.5; otBucket = "Overtime (1.5x)"; }
                if (tier === 2) { tierRate = 2.0; otBucket = "Overtime (2.0x)"; }
                
                if (tierRate > seg.penaltyRate) {
                    addToBucket(otBucket, dur, hourlyRate * tierRate);
                } else {
                    addToBucket(seg.bucket, dur, hourlyRate * seg.penaltyRate);
                }
                
                rem -= dur;
                currentH += dur;
            }
            cumulative += hrs;
        });

        // Helper
        function addToBucket(name, hrs, rateVal) {
            buckets[name].hrs += hrs;
            buckets[name].total += (hrs * rateVal);
        }

        function renderBadges(dayIdx, badgeSet) {
            let cell = document.getElementById(`status_${dayIdx}`);
            let html = "";
            badgeSet.forEach(b => {
                html += `<span class="badge ${b.css}">${b.txt}</span> `;
            });
            cell.innerHTML = html;
        }

        renderPayslip(buckets);
    }

    function renderPayslip(buckets) {
        const tbody = document.getElementById('payslipBody');
        tbody.innerHTML = '';
        let grandTotal = 0;

        for (const [name, data] of Object.entries(buckets)) {
            if (data.total < 0.01) continue;

            let unitTxt = data.hrs > 0 ? data.hrs.toFixed(2) + ' h' : data.count;
            let rateTxt = '$' + (data.rate || 0).toFixed(2);
            if(name === "PDA") { unitTxt = "F/N"; rateTxt = "Allow"; }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge ${data.css}" style="margin-right:10px">${name}</span></td>
                <td>${unitTxt}</td>
                <td>${rateTxt}</td>
                <td class="amount">$${data.total.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
            grandTotal += data.total;
        }
        document.getElementById('grossTotal').innerText = '$' + grandTotal.toFixed(2);
    }

    function copyToClipboard() {
        let text = "WA MEDICAL PAYSLIP (2025 Rates)\n";
        text += "Role: " + document.getElementById('roleSelector').value + "\n";
        text += "-------------------------------------\n";
        const rows = document.querySelectorAll('#payslipBody tr');
        rows.forEach(row => {
            const cols = row.querySelectorAll('td');
            text += `${cols[0].innerText.padEnd(25)} | ${cols[3].innerText}\n`;
        });
        text += "-------------------------------------\n";
        text += "TOTAL: " + document.getElementById('grossTotal').innerText;
        navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard"));
    }

    init();
</script>

</body>
</html>
